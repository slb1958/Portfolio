<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c0f;
    --surface: #111418;
    --surface2: #181c22;
    --border: #1e2530;
    --accent: #00e5a0;
    --accent2: #ff6b35;
    --red: #ff4757;
    --yellow: #ffd32a;
    --text: #e8edf5;
    --muted: #5a6478;
    --muted2: #8896b0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }
  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    opacity: 0.3;
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 24px 20px; }

  /* Header */
  header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; flex-wrap: wrap; gap: 16px; }
  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.4rem; letter-spacing: -0.02em; }
  .logo span { color: var(--accent); }
  .header-date { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }
  .header-actions { display: flex; gap: 10px; }
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 8px 16px; border-radius: 6px; font-family: 'DM Mono', monospace;
    font-size: 0.78rem; cursor: pointer; transition: all 0.2s; border: none; font-weight: 500;
  }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #00ffb3; transform: translateY(-1px); }
  .btn-ghost { background: transparent; color: var(--muted2); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
  .btn-danger:hover { background: var(--red); color: #fff; }

  /* KPI Cards */
  .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 32px; }
  .kpi {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 20px; position: relative; overflow: hidden;
    transition: border-color 0.2s;
  }
  .kpi:hover { border-color: var(--accent); }
  .kpi::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  }
  .kpi.green::after { background: var(--accent); }
  .kpi.orange::after { background: var(--accent2); }
  .kpi.red::after { background: var(--red); }
  .kpi.yellow::after { background: var(--yellow); }
  .kpi-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px; }
  .kpi-value { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.6rem; }
  .kpi-sub { font-size: 0.7rem; margin-top: 4px; }
  .pos { color: var(--accent); }
  .neg { color: var(--red); }

  /* Tabs */
  .tabs { display: flex; gap: 2px; margin-bottom: 24px; background: var(--surface); border-radius: 8px; padding: 4px; width: fit-content; }
  .tab { padding: 8px 18px; border-radius: 6px; cursor: pointer; font-size: 0.78rem; color: var(--muted); transition: all 0.2s; }
  .tab.active { background: var(--border); color: var(--text); }
  .tab:hover:not(.active) { color: var(--text); }

  /* Charts section */
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }
  @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }
  .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 24px; }
  .chart-title { font-family: 'Syne', sans-serif; font-size: 0.85rem; font-weight: 600; margin-bottom: 20px; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.08em; }
  svg text { font-family: 'DM Mono', monospace; }

  /* Pie chart */
  .pie-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--muted2); }
  .legend-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }

  /* Bar chart */
  .bar-chart { display: flex; flex-direction: column; gap: 8px; }
  .bar-row { display: flex; align-items: center; gap: 10px; }
  .bar-label { font-size: 0.7rem; color: var(--muted2); width: 60px; text-align: right; flex-shrink: 0; }
  .bar-track { flex: 1; height: 20px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 3px; transition: width 1s ease; display: flex; align-items: center; padding-left: 6px; font-size: 0.65rem; font-weight: 500; color: #000; }
  .bar-val { font-size: 0.68rem; color: var(--muted2); width: 60px; flex-shrink: 0; }

  /* Table */
  .table-wrapper { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .table-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 12px; }
  .table-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; }
  .search-box { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; }
  .search-box input { background: none; border: none; color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.78rem; outline: none; width: 160px; }
  .search-box input::placeholder { color: var(--muted); }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    padding: 10px 16px; text-align: left; font-size: 0.65rem; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none; white-space: nowrap;
  }
  thead th:hover { color: var(--accent); }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:hover { background: var(--surface2); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 12px 16px; font-size: 0.78rem; white-space: nowrap; }
  .ticker-cell { font-weight: 500; color: var(--accent); }
  .name-cell { color: var(--muted2); font-size: 0.72rem; max-width: 160px; overflow: hidden; text-overflow: ellipsis; }
  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem;
    font-weight: 500; text-transform: uppercase;
  }
  .badge-stock { background: rgba(0,229,160,0.1); color: var(--accent); }
  .badge-etf { background: rgba(255,107,53,0.1); color: var(--accent2); }
  .badge-crypto { background: rgba(255,211,42,0.12); color: var(--yellow); }
  .badge-other { background: rgba(255,71,87,0.1); color: var(--red); }
  .num { text-align: right; }
  .change-pos { color: var(--accent); }
  .change-neg { color: var(--red); }
  .change-neu { color: var(--muted2); }

  /* Modal */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    width: 100%; max-width: 520px; padding: 32px; position: relative;
    animation: slideUp 0.2s ease;
  }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  .modal-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.2rem; margin-bottom: 24px; }
  .modal-close { position: absolute; top: 20px; right: 20px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.2rem; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }
  label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
  input, select {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 0.8rem;
    padding: 10px 12px; outline: none; transition: border-color 0.2s;
  }
  input:focus, select:focus { border-color: var(--accent); }
  select option { background: var(--surface); }
  .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

  /* Alert panel */
  .alerts-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 24px; margin-bottom: 24px; }
  .alerts-title { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 0.85rem; color: var(--muted2); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .alert-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
  .alert-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .alert-item:last-child { border-bottom: none; }
  .alert-icon { font-size: 1rem; }
  .alert-text { font-size: 0.78rem; flex: 1; }
  .alert-text strong { color: var(--text); }
  .alert-text span { color: var(--muted); }

  /* Responsive */
  @media (max-width: 640px) {
    .kpis { grid-template-columns: 1fr 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: 1; }
    td { padding: 10px 10px; font-size: 0.72rem; }
    thead th { padding: 8px 10px; }
    .hide-mobile { display: none; }
  }

  /* View sections */
  .view { display: none; }
  .view.active { display: block; }

  /* Empty state */
  .empty { text-align: center; padding: 48px; color: var(--muted); font-size: 0.85rem; }
  .empty .icon { font-size: 3rem; margin-bottom: 12px; }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <header>
    <div>
      <div class="logo">PORT<span>FOLIO</span></div>
      <div class="header-date" id="currentDate"></div>
    </div>
    <div class="header-actions">
      <span id="sync-status" style="font-size:0.72rem;color:var(--muted);align-self:center;"></span>
      <button class="btn btn-ghost" onclick="loadFromSheet()" title="Recarregar do Google Sheets">â†º Sync</button>
      <button class="btn btn-ghost" onclick="openModal()">+ Adicionar</button>
      <button class="btn btn-primary" onclick="exportCSV()">â†“ Exportar</button>
    </div>
  </header>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi green">
      <div class="kpi-label">Capital Investido</div>
      <div class="kpi-value" id="kpi-invested">â‚¬0</div>
      <div class="kpi-sub muted">Total alocado</div>
    </div>
    <div class="kpi orange">
      <div class="kpi-label">Valor Atual</div>
      <div class="kpi-value" id="kpi-current">â‚¬0</div>
      <div class="kpi-sub" id="kpi-change-pct">â€”</div>
    </div>
    <div class="kpi yellow">
      <div class="kpi-label">+/- Valias</div>
      <div class="kpi-value" id="kpi-gain">â‚¬0</div>
      <div class="kpi-sub" id="kpi-gain-pct">â€”</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Dividendos Recebidos</div>
      <div class="kpi-value" id="kpi-div">â‚¬0</div>
      <div class="kpi-sub muted">Total acumulado</div>
    </div>
    <div class="kpi orange">
      <div class="kpi-label">NÂº PosiÃ§Ãµes</div>
      <div class="kpi-value" id="kpi-count">0</div>
      <div class="kpi-sub muted">Ativos ativos</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
    <div class="tab" onclick="switchTab('portfolio')">PortfÃ³lio</div>
    <div class="tab" onclick="switchTab('alerts')">Alertas</div>
  </div>

  <!-- Dashboard View -->
  <div class="view active" id="view-dashboard">
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">AlocaÃ§Ã£o por Tipo</div>
        <div style="display:flex;align-items:center;gap:24px;">
          <svg id="pie-svg" width="160" height="160" viewBox="0 0 160 160"></svg>
          <div class="pie-legend" id="pie-legend"></div>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Top PosiÃ§Ãµes (% da Carteira)</div>
        <div class="bar-chart" id="bar-chart"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Performance por Ativo (â‚¬)</div>
        <div class="bar-chart" id="perf-chart"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">AlocaÃ§Ã£o por Corretora</div>
        <div class="bar-chart" id="broker-chart"></div>
      </div>
    </div>
  </div>

  <!-- Portfolio View -->
  <div class="view" id="view-portfolio">
    <div class="table-wrapper">
      <div class="table-header">
        <div class="table-title">PortfÃ³lio</div>
        <div class="search-box">
          <span style="color:var(--muted);font-size:0.9rem;">âŒ•</span>
          <input type="text" placeholder="Pesquisar ativo..." id="search-input" oninput="filterTable()">
        </div>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th onclick="sortTable('ticker')">Ticker â†•</th>
              <th>Nome</th>
              <th class="hide-mobile">Tipo</th>
              <th class="hide-mobile">Corretora</th>
              <th class="num">Investido</th>
              <th class="num">Atual</th>
              <th class="num">+/- Valia</th>
              <th class="num">+/- %</th>
              <th class="hide-mobile num">Dividendos</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="portfolio-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Alerts View -->
  <div class="view" id="view-alerts">
    <div class="alerts-panel">
      <div class="alerts-title"><div class="alert-dot"></div> Alertas Ativos</div>
      <div id="alerts-list"></div>
    </div>
    <div class="table-wrapper">
      <div class="table-header">
        <div class="table-title">Configurar Alertas de PreÃ§o</div>
        <button class="btn btn-primary" onclick="openAlertModal()">+ Novo Alerta</button>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr><th>Ativo</th><th>CondiÃ§Ã£o</th><th>PreÃ§o Alvo</th><th>Estado</th><th></th></tr></thead>
          <tbody id="alerts-tbody"></tbody>
        </table>
      </div>
      <div class="empty" id="alerts-empty" style="display:none;">
        <div class="icon">ðŸ””</div>
        Ainda nÃ£o criaste alertas. Adiciona um alerta para seres notificado quando um ativo atingir o preÃ§o alvo.
      </div>
    </div>
  </div>

</div>

<!-- Add Investment Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title" id="modal-title">Adicionar Investimento</div>
    <button class="modal-close" onclick="closeModal()">âœ•</button>
    <div class="form-grid">
      <div class="form-group">
        <label>Ticker</label>
        <input type="text" id="f-ticker" placeholder="ex: VWCE">
      </div>
      <div class="form-group">
        <label>Nome</label>
        <input type="text" id="f-name" placeholder="Nome completo">
      </div>
      <div class="form-group">
        <label>Tipo</label>
        <select id="f-type">
          <option value="AÃ§Ã£o">AÃ§Ã£o</option>
          <option value="ETF">ETF</option>
          <option value="Crypto">Crypto</option>
          <option value="Outro">Outro</option>
        </select>
      </div>
      <div class="form-group">
        <label>Moeda</label>
        <select id="f-currency">
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
        </select>
      </div>
      <div class="form-group">
        <label>Corretora</label>
        <input type="text" id="f-broker" placeholder="ex: XTB, T212">
      </div>
      <div class="form-group">
        <label>Data de Compra</label>
        <input type="date" id="f-date">
      </div>
      <div class="form-group">
        <label>PreÃ§o de Compra</label>
        <input type="number" id="f-price" step="0.0001" placeholder="0.00">
      </div>
      <div class="form-group">
        <label>Quantidade</label>
        <input type="number" id="f-qty" step="0.000001" placeholder="0">
      </div>
      <div class="form-group">
        <label>PreÃ§o Atual</label>
        <input type="number" id="f-current" step="0.0001" placeholder="0.00">
      </div>
      <div class="form-group">
        <label>Dividendos Recebidos</label>
        <input type="number" id="f-div" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group full">
        <label>Meses de Dividendos</label>
        <input type="text" id="f-divmonths" placeholder="ex: Jan/Abr/Jul/Out ou Mensal">
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveInvestment()">Guardar</button>
    </div>
  </div>
</div>

<!-- Alert Modal -->
<div class="modal-overlay" id="alert-modal">
  <div class="modal">
    <div class="modal-title">Novo Alerta de PreÃ§o</div>
    <button class="modal-close" onclick="closeAlertModal()">âœ•</button>
    <div class="form-grid">
      <div class="form-group">
        <label>Ativo</label>
        <select id="a-ticker"></select>
      </div>
      <div class="form-group">
        <label>CondiÃ§Ã£o</label>
        <select id="a-cond">
          <option value="above">PreÃ§o acima de</option>
          <option value="below">PreÃ§o abaixo de</option>
        </select>
      </div>
      <div class="form-group full">
        <label>PreÃ§o Alvo</label>
        <input type="number" id="a-price" step="0.01" placeholder="0.00">
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-ghost" onclick="closeAlertModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveAlert()">Criar Alerta</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbzq7L3lrP3_5Far6ZagmPzDgecQjVRD0fXHXWHEurdjLny7VmR5JzOATSrPH_3Da-pbMg/exec';

// â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let data = [];
let alerts = JSON.parse(localStorage.getItem('alerts') || '[]');
let editIdx = null;
let sortKey = null, sortAsc = true;
let isSaving = false;

// Status indicator
function setStatus(msg, color='var(--muted)') {
  let el = document.getElementById('sync-status');
  if(!el) return;
  el.textContent = msg;
  el.style.color = color;
}

function loadFromSheet() {
  setStatus('A carregar...', 'var(--yellow)');
  const cbName = 'gsCallback_' + Date.now();
  const script = document.createElement('script');
  script.src = SHEET_URL + '?callback=' + cbName;
  script.onerror = () => {
    setStatus('âš  Erro ao carregar dados', 'var(--red)');
    document.body.removeChild(script);
  };
  window[cbName] = function(raw) {
    delete window[cbName];
    document.body.removeChild(script);
    data = raw.map(r => ({
      ticker: String(r.ticker || ''),
      name: String(r.nome || ''),
      type: String(r.tipo || 'Outro'),
      currency: String(r.moeda || 'EUR'),
      broker: String(r.corretora || '-'),
      date: String(r.data || ''),
      buyPrice: parseFloat(r.buyPrice) || 0,
      qty: parseFloat(r.qty) || 0,
      invested: parseFloat(r.invested) || 0,
      current: parseFloat(r.current) || 0,
      gain: parseFloat(r.gain) || 0,
      gainPct: parseFloat(r.gainPct) || 0,
      dividends: parseFloat(r.dividends) || 0,
      divMonths: String(r.divMonths || '-'),
    })).filter(r => r.ticker);
    setStatus('âœ“ Sincronizado com Google Sheets', 'var(--accent)');
    renderAll();
  };
  document.body.appendChild(script);
}

async function save() {
  if(isSaving) return;
  isSaving = true;
  setStatus('A guardar...', 'var(--yellow)');
  localStorage.setItem('alerts', JSON.stringify(alerts));
  try {
    const payload = { action: 'save', data: data.map(r => ({
      ticker: r.ticker, nome: r.name, tipo: r.type, moeda: r.currency,
      corretora: r.broker, data: r.date, buyPrice: r.buyPrice, qty: r.qty,
      invested: r.invested, current: r.current, gain: r.gain,
      gainPct: r.gainPct, dividends: r.dividends, divMonths: r.divMonths
    }))};
    // POST via form to bypass CORS
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = SHEET_URL;
    form.target = 'save_frame';
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'payload';
    input.value = JSON.stringify(payload);
    form.appendChild(input);
    // Hidden iframe
    let iframe = document.getElementById('save_frame');
    if(!iframe) {
      iframe = document.createElement('iframe');
      iframe.name = 'save_frame';
      iframe.id = 'save_frame';
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
    }
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    setTimeout(() => setStatus('âœ“ Guardado no Google Sheets', 'var(--accent)'), 1500);
  } catch(e) {
    setStatus('âš  Erro ao guardar', 'var(--red)');
  }
  isSaving = false;
}

// â”€â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeKPIs() {
  const inv = data.reduce((s,r) => s + (r.invested||0), 0);
  const cur = data.reduce((s,r) => s + (r.current||0), 0);
  const gain = cur - inv;
  const div = data.reduce((s,r) => s + (r.dividends||0), 0);
  const gainPct = inv > 0 ? gain/inv*100 : 0;
  document.getElementById('kpi-invested').textContent = fmt(inv);
  document.getElementById('kpi-current').textContent = fmt(cur);
  document.getElementById('kpi-gain').textContent = (gain>=0?'+':'')+fmt(gain);
  document.getElementById('kpi-gain').className = 'kpi-value ' + (gain>=0?'pos':'neg');
  document.getElementById('kpi-gain-pct').textContent = (gainPct>=0?'+':'')+gainPct.toFixed(2)+'%';
  document.getElementById('kpi-gain-pct').className = gainPct>=0 ? 'kpi-sub pos' : 'kpi-sub neg';
  document.getElementById('kpi-div').textContent = fmt(div);
  document.getElementById('kpi-count').textContent = data.filter(r=>r.ticker!=='CASH').length;
  const changePct = gainPct.toFixed(2);
  document.getElementById('kpi-change-pct').textContent = (changePct>=0?'+':'')+changePct+'% vs investido';
  document.getElementById('kpi-change-pct').className = changePct>=0 ? 'kpi-sub pos' : 'kpi-sub neg';
}

function fmt(v) { return 'â‚¬'+Math.abs(v).toLocaleString('pt-PT', {minimumFractionDigits:2, maximumFractionDigits:2}); }

// â”€â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = { 'AÃ§Ã£o':'#00e5a0', 'ETF':'#ff6b35', 'Crypto':'#ffd32a', 'Outro':'#8896b0' };
const COLORS_ARR = ['#00e5a0','#ff6b35','#ffd32a','#4ecdc4','#45b7d1','#96ceb4','#ff8c94','#a29bfe','#fd79a8','#00b894'];

function drawPie() {
  const byType = {};
  data.forEach(r => { byType[r.type] = (byType[r.type]||0) + (r.current||0); });
  const total = Object.values(byType).reduce((a,b)=>a+b,0);
  const svg = document.getElementById('pie-svg');
  svg.innerHTML = '';
  const legend = document.getElementById('pie-legend');
  legend.innerHTML = '';
  let angle = -Math.PI/2;
  Object.entries(byType).forEach(([type, val]) => {
    const pct = val/total;
    const sweep = pct * 2 * Math.PI;
    const x1 = 80 + 70 * Math.cos(angle);
    const y1 = 80 + 70 * Math.sin(angle);
    angle += sweep;
    const x2 = 80 + 70 * Math.cos(angle);
    const y2 = 80 + 70 * Math.sin(angle);
    const large = sweep > Math.PI ? 1 : 0;
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', `M80,80 L${x1},${y1} A70,70 0 ${large},1 ${x2},${y2} Z`);
    path.setAttribute('fill', COLORS[type]||'#8896b0');
    path.setAttribute('opacity', '0.85');
    svg.appendChild(path);
    legend.innerHTML += `<div class="legend-item"><div class="legend-dot" style="background:${COLORS[type]||'#8896b0'}"></div>${type} ${(pct*100).toFixed(1)}%</div>`;
  });
  // Center hole
  const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
  circle.setAttribute('cx','80'); circle.setAttribute('cy','80'); circle.setAttribute('r','38');
  circle.setAttribute('fill','#111418');
  svg.appendChild(circle);
  const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
  txt.setAttribute('x','80'); txt.setAttribute('y','86'); txt.setAttribute('text-anchor','middle');
  txt.setAttribute('fill','#8896b0'); txt.setAttribute('font-size','10');
  txt.textContent = 'â‚¬'+Math.round(total).toLocaleString('pt-PT');
  svg.appendChild(txt);
}

function drawBar(elId, items, colorFn) {
  const el = document.getElementById(elId);
  const max = Math.max(...items.map(i=>Math.abs(i.val)));
  el.innerHTML = items.slice(0,8).map(item => {
    const pct = max > 0 ? Math.abs(item.val)/max*100 : 0;
    const color = colorFn ? colorFn(item) : COLORS_ARR[0];
    return `<div class="bar-row">
      <div class="bar-label">${item.label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}">${pct>15?item.sub||'':''}</div></div>
      <div class="bar-val" style="color:${item.val<0?'var(--red)':'var(--muted2)'}">${item.val<0?'-':''}â‚¬${Math.abs(item.val).toFixed(0)}</div>
    </div>`;
  }).join('');
}

function drawCharts() {
  drawPie();
  // Top positions
  const tops = [...data].filter(r=>r.invested>0).sort((a,b)=>b.current-a.current);
  const totalCur = data.reduce((s,r)=>s+(r.current||0),0);
  drawBar('bar-chart', tops.map((r,i)=>({label:r.ticker, val:r.current, sub:(r.current/totalCur*100).toFixed(1)+'%'})), (_,i) => COLORS_ARR[i%COLORS_ARR.length]);

  // Performance
  const perfs = [...data].filter(r=>r.gain!==0).sort((a,b)=>b.gain-a.gain);
  drawBar('perf-chart', perfs.map(r=>({label:r.ticker, val:r.gain})), r => r.val>=0 ? 'var(--accent)' : 'var(--red)');

  // Brokers
  const byBroker = {};
  data.forEach(r => { if(r.broker&&r.broker!=='-') byBroker[r.broker] = (byBroker[r.broker]||0) + (r.current||0); });
  const brokerItems = Object.entries(byBroker).sort((a,b)=>b[1]-a[1]).map(([k,v],i)=>({label:k,val:v}));
  drawBar('broker-chart', brokerItems, (_,i) => COLORS_ARR[(i+2)%COLORS_ARR.length]);
}

// â”€â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let filterStr = '';

function filterTable() {
  filterStr = document.getElementById('search-input').value.toLowerCase();
  renderTable();
}

function sortTable(key) {
  if(sortKey===key) sortAsc=!sortAsc; else { sortKey=key; sortAsc=true; }
  renderTable();
}

function renderTable() {
  let rows = [...data];
  if(filterStr) rows = rows.filter(r => r.ticker.toLowerCase().includes(filterStr) || r.name.toLowerCase().includes(filterStr));
  if(sortKey) rows.sort((a,b) => { const v = a[sortKey]>b[sortKey]?1:-1; return sortAsc?v:-v; });
  const body = document.getElementById('portfolio-tbody');
  body.innerHTML = rows.map((r,i) => {
    const idx = data.indexOf(r);
    const gClass = r.gain>0?'change-pos':r.gain<0?'change-neg':'change-neu';
    const typeClass = {'AÃ§Ã£o':'badge-stock','ETF':'badge-etf','Crypto':'badge-crypto','Outro':'badge-other'}[r.type]||'badge-other';
    return `<tr>
      <td class="ticker-cell">${r.ticker}</td>
      <td class="name-cell">${r.name}</td>
      <td class="hide-mobile"><span class="badge ${typeClass}">${r.type}</span></td>
      <td class="hide-mobile" style="color:var(--muted2)">${r.broker||'-'}</td>
      <td class="num">â‚¬${(r.invested||0).toFixed(2)}</td>
      <td class="num">â‚¬${(r.current||0).toFixed(2)}</td>
      <td class="num ${gClass}">${r.gain>=0?'+':''}â‚¬${(r.gain||0).toFixed(2)}</td>
      <td class="num ${gClass}">${r.gainPct>=0?'+':''}${(r.gainPct||0).toFixed(2)}%</td>
      <td class="num hide-mobile" style="color:var(--accent)">â‚¬${(r.dividends||0).toFixed(2)}</td>
      <td>
        <button class="btn btn-ghost" style="padding:4px 10px;font-size:0.65rem;" onclick="editInvestment(${idx})">âœŽ</button>
        <button class="btn btn-danger" style="padding:4px 10px;font-size:0.65rem;margin-left:4px;" onclick="deleteInvestment(${idx})">âœ•</button>
      </td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAlerts() {
  // Active alerts list
  const triggered = alerts.filter(a => {
    const row = data.find(r=>r.ticker===a.ticker);
    if(!row) return false;
    return a.cond==='above' ? row.current >= a.price : row.current <= a.price;
  });
  const alertList = document.getElementById('alerts-list');
  if(triggered.length === 0) {
    alertList.innerHTML = '<div style="color:var(--muted);font-size:0.78rem;padding:8px 0;">Nenhum alerta ativo de momento.</div>';
  } else {
    alertList.innerHTML = triggered.map(a => {
      const row = data.find(r=>r.ticker===a.ticker);
      return `<div class="alert-item">
        <div class="alert-icon">${a.cond==='above'?'ðŸ“ˆ':'ðŸ“‰'}</div>
        <div class="alert-text"><strong>${a.ticker}</strong> <span>atingiu o alerta de preÃ§o ${a.cond==='above'?'acima':'abaixo'} de â‚¬${a.price} â€” preÃ§o atual: â‚¬${row.current.toFixed(2)}</span></div>
      </div>`;
    }).join('');
  }
  // Alerts table
  const tbody = document.getElementById('alerts-tbody');
  const empty = document.getElementById('alerts-empty');
  if(alerts.length===0) { empty.style.display='block'; tbody.innerHTML=''; return; }
  empty.style.display='none';
  tbody.innerHTML = alerts.map((a,i) => {
    const row = data.find(r=>r.ticker===a.ticker);
    const fired = row && (a.cond==='above' ? row.current>=a.price : row.current<=a.price);
    return `<tr>
      <td class="ticker-cell">${a.ticker}</td>
      <td style="color:var(--muted2)">${a.cond==='above'?'â‰¥ Acima de':'â‰¤ Abaixo de'}</td>
      <td>â‚¬${a.price}</td>
      <td><span class="badge ${fired?'badge-stock':'badge-other'}">${fired?'âš¡ Ativo':'Pendente'}</span></td>
      <td><button class="btn btn-danger" style="padding:4px 10px;font-size:0.65rem;" onclick="deleteAlert(${i})">âœ•</button></td>
    </tr>`;
  }).join('');
}

function openAlertModal() {
  const sel = document.getElementById('a-ticker');
  sel.innerHTML = [...new Set(data.map(r=>r.ticker))].map(t=>`<option value="${t}">${t}</option>`).join('');
  document.getElementById('alert-modal').classList.add('open');
}
function closeAlertModal() { document.getElementById('alert-modal').classList.remove('open'); }
function saveAlert() {
  const ticker = document.getElementById('a-ticker').value;
  const cond = document.getElementById('a-cond').value;
  const price = parseFloat(document.getElementById('a-price').value);
  if(!ticker || isNaN(price)) return;
  alerts.push({ticker, cond, price});
  save(); renderAlerts(); closeAlertModal();
}
function deleteAlert(i) { alerts.splice(i,1); save(); renderAlerts(); }

// â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(idx=null) {
  editIdx = idx;
  document.getElementById('modal-title').textContent = idx!==null ? 'Editar Investimento' : 'Adicionar Investimento';
  if(idx!==null) {
    const r = data[idx];
    document.getElementById('f-ticker').value = r.ticker;
    document.getElementById('f-name').value = r.name;
    document.getElementById('f-type').value = r.type;
    document.getElementById('f-currency').value = r.currency;
    document.getElementById('f-broker').value = r.broker||'';
    document.getElementById('f-date').value = r.date||'';
    document.getElementById('f-price').value = r.buyPrice||'';
    document.getElementById('f-qty').value = r.qty||'';
    document.getElementById('f-current').value = r.current||'';
    document.getElementById('f-div').value = r.dividends||'';
    document.getElementById('f-divmonths').value = r.divMonths||'';
  } else {
    ['f-ticker','f-name','f-broker','f-date','f-price','f-qty','f-current','f-div','f-divmonths'].forEach(id => document.getElementById(id).value='');
  }
  document.getElementById('modal').classList.add('open');
}
function closeModal() { document.getElementById('modal').classList.remove('open'); editIdx=null; }

function saveInvestment() {
  const ticker = document.getElementById('f-ticker').value.trim().toUpperCase();
  const name = document.getElementById('f-name').value.trim();
  const type = document.getElementById('f-type').value;
  const currency = document.getElementById('f-currency').value;
  const broker = document.getElementById('f-broker').value.trim();
  const date = document.getElementById('f-date').value;
  const buyPrice = parseFloat(document.getElementById('f-price').value)||0;
  const qty = parseFloat(document.getElementById('f-qty').value)||0;
  const current = parseFloat(document.getElementById('f-current').value)||0;
  const dividends = parseFloat(document.getElementById('f-div').value)||0;
  const divMonths = document.getElementById('f-divmonths').value.trim();
  if(!ticker||!name) return;
  const invested = buyPrice * qty;
  const gain = current - invested;
  const gainPct = invested > 0 ? gain/invested*100 : 0;
  const row = { ticker, name, type, currency, broker, date, buyPrice, qty, invested, current, gain, gainPct, dividends, divMonths };
  if(editIdx!==null) data[editIdx]=row; else data.push(row);
  save(); renderAll(); closeModal();
}

function editInvestment(idx) { openModal(idx); switchTab('portfolio'); }
function deleteInvestment(idx) {
  if(confirm(`Remover ${data[idx].ticker}?`)) { data.splice(idx,1); save(); renderAll(); }
}

// â”€â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const headers = ['Ticker','Nome','Tipo','Moeda','Corretora','Data','PreÃ§o Compra','QT','Investido','Atual','Valia','Valia%','Dividendos'];
  const rows = data.map(r=>[r.ticker,r.name,r.type,r.currency,r.broker,r.date,r.buyPrice,r.qty,r.invested.toFixed(2),r.current.toFixed(2),r.gain.toFixed(2),(r.gainPct||0).toFixed(2),r.dividends]);
  const csv = [headers, ...rows].map(r=>r.join(';')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = 'portfolio_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
}

// â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((el,i) => {
    const tabs = ['dashboard','portfolio','alerts'];
    el.classList.toggle('active', tabs[i]===tab);
  });
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById('view-'+tab).classList.add('active');
  if(tab==='dashboard') drawCharts();
  if(tab==='portfolio') renderTable();
  if(tab==='alerts') renderAlerts();
}

function renderAll() { computeKPIs(); drawCharts(); renderTable(); renderAlerts(); }

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-PT', {weekday:'long',day:'numeric',month:'long',year:'numeric'});
loadFromSheet();
</script>
</body>
</html>
